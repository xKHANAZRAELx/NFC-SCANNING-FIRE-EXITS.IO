<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Tag Scanner with Firestore</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        #output {
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>

    <h1>NFC Tag Scanner with Firestore</h1>
    <div id="output">Waiting for NFC tag...</div>

    <script type="module">
        // Import Firebase SDK and Firestore
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDj2uosWcsHdGWm31_w_5LJ-i34IGZY_us",
            authDomain: "nfc-scan-tracker.firebaseapp.com",
            databaseURL: "https://nfc-scan-tracker-default-rtdb.firebaseio.com",
            projectId: "nfc-scan-tracker",
            storageBucket: "nfc-scan-tracker.appspot.com",
            messagingSenderId: "565206205474",
            appId: "1:565206205474:web:5959b2c68c0415a082b67b",
            measurementId: "G-TWLF5S7T40"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Initialize Firestore
        const db = getFirestore(app);

        // Function to save NFC scan data to Firestore
        async function saveScanToFirestore(location, timeOfDay, date) {
            try {
                const docRef = await addDoc(collection(db, "scans"), {
                    location: location,
                    timeOfDay: timeOfDay,
                    date: date
                });
                console.log("Document written with ID: ", docRef.id);
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        // Function to detect NFC scan and save data to Firestore
        async function handleNFCScan() {
            if ('NDEFReader' in window) {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    document.getElementById('output').textContent = 'NFC scanning started. Bring the NFC tag close to your device.';

                    ndef.onreading = event => {
                        const { serialNumber, message } = event;
                        let messageText = '';

                        // Process NFC tag message
                        for (const record of message.records) {
                            if (record.recordType === 'text') {
                                const textDecoder = new TextDecoder(record.encoding);
                                messageText = textDecoder.decode(record.data);
                            }
                        }

                        // Log scanned NFC tag
                        document.getElementById('output').textContent = `NFC Tag scanned: ${messageText}`;

                        // Get the current time and date
                        const now = new Date();
                        const currentDate = now.toLocaleString();
                        const timeOfDay = now.getHours() < 12 ? 'morning' : 'afternoon';

                        // Save the NFC scan to Firestore
                        saveScanToFirestore(messageText, timeOfDay, currentDate);
                    };

                    ndef.onreadingerror = () => {
                        document.getElementById('output').textContent = 'Failed to read the NFC tag. Try again.';
                    };
                } catch (error) {
                    document.getElementById('output').textContent = `Error: ${error.message}`;
                }
            } else {
                document.getElementById('output').textContent = 'Web NFC is not supported on this device.';
            }
        }

        // Start NFC scanning when the page loads
        window.addEventListener('load', handleNFCScan);
    </script>

</body>
</html>
